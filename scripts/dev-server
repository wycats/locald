#!/bin/bash
set -e

# 1. Build the project (including the shim)
echo "ğŸ“¦ Building locald..."
cargo build

# 2. Find the shim
SHIM_PATH=$(ls target/debug/build/locald-cli-*/out/shim-target/release/locald-shim | head -n 1)

if [ -z "$SHIM_PATH" ]; then
    echo "âŒ Could not find locald-shim build artifact."
    exit 1
fi

# 3. Check/Fix Permissions
# We check if it has the setuid bit (4000) and is owned by root
if [ ! -u "$SHIM_PATH" ] || [ "$(stat -c '%u' "$SHIM_PATH")" != "0" ]; then
    echo "ğŸ”’ Fixing shim permissions (requires sudo)..."
    sudo chown root:root "$SHIM_PATH"
    sudo chmod u+s "$SHIM_PATH"
    echo "âœ… Permissions fixed."
else
    echo "âœ… Shim permissions OK."
fi

# 4. Run the server
# We pass the explicit path to the shim so the server knows which one to use.
echo "ğŸš€ Starting locald server..."
export LOCALD_SHIM_PATH="$SHIM_PATH"
exec target/debug/locald "$@"
