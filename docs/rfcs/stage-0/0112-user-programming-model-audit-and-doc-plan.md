---
title: "User Programming Model Audit and Doc Plan"
stage: 0
feature: Documentation / UX Coherence
---

# User Programming Model Audit and Doc Plan

## 1) Summary

This audit artifact is a living coherence report that aims to make the _taught model_ (docs/RFCs) match the _required model_ (what users must actually do to succeed).

It produces:

- A **Claim ledger** (docs → code verification) with a status per claim: **OK / Drift / Ambiguous**.
- An **Undocumented capability ledger** (code → doc proposals), focused on adoption friction and boundary clarity.
- **Persona-aligned golden paths** (install → configure → build/generate → integrate → debug → ship).
- A **STOP list** of **Conflict Cards** that require a user decision before proceeding to the next audit epoch.

**Current state:** Epoch 1 (CLI/entry points contract) is in progress.

## 2) Motivation

Coherence between docs/RFCs and implementation matters because:

- **Adoption:** New users follow taught “golden paths”; drift becomes immediate failure or mistrust.
- **Maintenance:** A clear programming model reduces support load and prevents new “shadow workflows”.
- **Enforcement:** If the repo enforces contracts (shim integrity, sandbox constraints, config rules), they must be taught as explicit boundaries.
- **Integration:** Tools and CI/scripts encode assumptions; aligning them prevents silent coupling and brittle onboarding.

## 3) Scope

### In scope

Normative and user-facing sources:

- Root docs and orientation: README (README.md)
- Design vision/axioms/personas: docs/design/\*
- Manual (current reality): docs/manual/\*
- RFCs (decision history): docs/rfcs/\*
- Docs site content (user-facing, navigation-routed): locald-docs/src/content/docs/\*

Observed implementation surfaces:

- CLI surface and behavior: locald-cli/src/\*
- Core user config types: locald-core/src/config/\*
- State/registry behavior: locald-core/src/registry.rs
- IPC and sandbox constraints: locald-utils/src/ipc.rs and locald-cli/src/utils.rs
- Scripts that present “contract of use”: scripts/\* (not yet audited)
- Examples and e2e harnesses: examples/_, locald-e2e/_ (not yet audited)

### Out of scope

- Any code/config/build/CI changes.
- Refactors, formatting, cleanup.

### Audit epochs

- **Epoch 0: Orient** (current): Read normative sources; seed stated model + initial claim ledger.
- **Epoch 1: CLI/entry points contract**: Commands, flags, defaults, and UX boundaries.
- **Epoch 2: Runtime/API contract**: Public types/events, daemon expectations, default behaviors.
- **Epoch 3: Integration boundaries**: Adapters, bridges, “no plumbing” rules, privilege boundaries.
- **Epoch 4: Tooling UX**: Generators/scaffolds/inspectors/debug UIs/templates.
- **Epoch 5: Enforcement & audits**: Linters, checks, CI tripwires, golden masters.
- **Epoch 6: Composition audit**: Unify into persona workflows; identify feature islands.

## 4) User Programming Model (Stated)

This section extracts explicit user-model claims from docs/RFCs (no interpretation). Each claim is represented in the Claim Ledger.

### Key primitives taught

- **Workspace as a first-class unit** (docs/design/vision.md; docs/rfcs/0026-configuration-hierarchy.md)
- **Services as managed citizens** (docs/manual/vision.md; docs/design/vision.md)
- **Daemon-first architecture** (docs/design/axioms.md; docs/design/user-interaction-modes.md)
- **Configuration as in-repo (locald.toml)** (README.md; locald-cli/README.md; docs/rfcs/0026-configuration-hierarchy.md)
- **Personas as documentation routing** (docs/design/personas.md; docs/rfcs/0014-documentation-personas.md)

### Supported user intents taught

- “Clone → locald up” as a low-friction start (docs/design/vision.md; docs/manual/vision.md; README.md)
- Run/observe services (docs/design/vision.md; docs/design/user-interaction-modes.md)
- Use a dashboard/TUI to observe and interact (docs/design/vision.md; docs/design/user-interaction-modes.md)
- Configure via locald.toml and (per RFC) layered config + provenance tooling (docs/rfcs/0026-configuration-hierarchy.md)

### Contracts and boundaries taught

- Privilege separation and a privileged shim for some features (README.md; docs/design/axioms.md)
- Command surface should map to user intent (docs/rfcs/0086-cli-surface-overhaul.md)

### Determinism / provenance / auditing promises taught

- Config provenance visibility (“where did a value come from”) (docs/rfcs/0026-configuration-hierarchy.md)

### Seed list of extracted claims

See Claim Ledger rows CL-001 … CL-010.

**Resolution note (C-001):** Canonical user-facing docs should teach `locald up` / `locald monitor` / `locald registry clean`.

## 5) User Programming Model (Observed)

This section inventories what appears true from the repository’s implementation surfaces (no editorializing).

### Entry points

- Primary CLI binary is named **locald** (locald-cli/src/cli.rs: `#[command(name = "locald")]`).
- The CLI supports (at least): `init`, `up`, `status`, `logs`, `stop`, `restart`, `monitor`, `dashboard`, `trust`, `doctor`, `server start|shutdown|restart`, `admin setup|sync-hosts`, `config show`, `registry list|pin|unpin|clean` (locald-cli/src/cli.rs).

### Defaults and paths

- Default IPC socket path is `/tmp/locald.sock` unless `LOCALD_SOCKET` is set (locald-utils/src/ipc.rs).
- `LOCALD_SOCKET` is rejected unless `LOCALD_SANDBOX_ACTIVE` is also set (locald-utils/src/ipc.rs).
- CLI `--sandbox <name>` sets XDG dirs + `LOCALD_SOCKET` + `LOCALD_SANDBOX_ACTIVE`/`LOCALD_SANDBOX_NAME` (locald-cli/src/utils.rs).
- Registry path resolves to XDG data local dir `.../registry.json` via `directories::ProjectDirs` (locald-core/src/registry.rs).

### Hidden coupling / required ordering

- Many commands auto-start the daemon as needed (locald-cli/src/utils.rs: `ensure_daemon_running`; locald-cli/src/handlers.rs for `up` handler).
- Shim verification happens for most commands (locald-cli/src/main.rs calls `utils::verify_shim()` except admin setup + doctor).

### Additional capabilities found in code

- `locald config show --provenance` flag exists (locald-cli/src/cli.rs).
- `locald ai schema` and `locald ai context` exist (locald-cli/src/cli.rs).

## 6) Claim Ledger (Docs → Code Verification)

| Claim                                                                                                                                                                                                                                     | Source                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | Implementation evidence                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | Status (OK/Drift/Ambiguous) | Persona impact                                                                                                                                                                                | Notes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ---------- | ---------------------------------------------------------------------------------------------------------------- |
| CL-001: The primary user entrypoint is the `locald` CLI.                                                                                                                                                                                  | README.md (“CLI (user entrypoint): locald-cli/”); locald-cli/README.md                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | locald-cli/src/cli.rs sets `name = "locald"`; locald-cli/src/main.rs parses CLI.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | OK                          | App Builder / Power User                                                                                                                                                                      | This is stable and safe to teach.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| CL-002: “Clone → `locald up`” is the primary zero-friction start.                                                                                                                                                                         | docs/design/vision.md; docs/manual/vision.md; README.md                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | locald-cli/src/handlers.rs implements `Commands::Up` and starts daemon if needed; locald-cli/README.md documents `locald up`.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | OK                          | App Builder                                                                                                                                                                                   | Handler prints “Daemon is running” when no locald.toml exists.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| CL-003: The CLI auto-starts the daemon when needed (daemon bootstrap).                                                                                                                                                                    | locald-cli/README.md (“Most commands will start the daemon automatically if needed.”)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | locald-cli/src/utils.rs: `ensure_daemon_running()` + `spawn_daemon()`; locald-cli/src/handlers.rs calls `ensure_daemon_running()` for status/logs.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | OK                          | App Builder / Power User                                                                                                                                                                      | `up` also spawns daemon directly in handler.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| CL-004: Some features require a privileged shim; users install/repair via `sudo locald admin setup`.                                                                                                                                      | README.md (“Install/repair: sudo locald admin setup”)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | locald-cli/src/cli.rs defines `admin setup`; locald-cli/src/main.rs verifies shim for most commands; locald-cli/src/utils.rs prints remediation command.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | OK                          | App Builder                                                                                                                                                                                   | Shim auto-fix requires `LOCALD_SHIM_AUTO_FIX=1` (undocumented; see UCL).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| CL-005: Registry exists and lives at `~/.local/share/locald/registry.json`.                                                                                                                                                               | docs/rfcs/0026-configuration-hierarchy.md (“Location: ~/.local/share/locald/registry.json”)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | locald-core/src/registry.rs uses `directories::ProjectDirs(...).data_local_dir().join("registry.json")`.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | OK                          | Power User                                                                                                                                                                                    | Also has fallback to `./locald-registry.json` if dirs unavailable.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| CL-006: CLI has registry management commands (list/clean/pin/unpin).                                                                                                                                                                      | docs/rfcs/0026-configuration-hierarchy.md (“CLI design: locald registry list/clean/pin/unpin”)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | locald-cli/src/cli.rs defines `Registry` commands; locald-core/src/registry.rs implements pin/unpin/prune.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | OK                          | Power User                                                                                                                                                                                    | `prune` name differs from RFC (uses `clean` in CLI).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| CL-007: Users can inspect config with provenance via `locald config show --provenance`.                                                                                                                                                   | docs/rfcs/0026-configuration-hierarchy.md (“CLI: locald config show --provenance”)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | locald-cli/src/handlers.rs prints global config path + `Debug` view of global config when `--provenance` is set; it does not explain per-value provenance nor show context/workspace/project layers (RFC 0026 example).                                                                                                                                                                                                                                                                                                                                                                                                                                                            | Drift                       | Power User                                                                                                                                                                                    | Conflict Card C-004 (stop): decide whether to implement full provenance output or revise the contract/docs.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| CL-008: Default routing UX is `*.localhost`.                                                                                                                                                                                              | docs/manual/vision.md (“\*.localhost routing is the default UX”); docs/rfcs/0024-default-domain-localhost.md (“Switch the default domain suffix from `.local` to `.localhost`.”); docs/agent-context/decisions.md (Decision 024: Default Domain: .localhost)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | locald-cli/src/init.rs defaults to `{project_name}.local` (interactive prompt) which will typically be accepted as an explicit domain; locald-cli/src/service.rs default uses `{project_name}.localhost`; locald-core/src/config/mod.rs says `{name}.localhost` when domain is None.                                                                                                                                                                                                                                                                                                                                                                                               | Drift                       | App Builder                                                                                                                                                                                   | This is Conflict Card C-003 (stop).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| CL-009: Project mode uses `locald.toml` in the current directory as the primary config file.                                                                                                                                              | docs/design/user-interaction-modes.md; locald-cli/README.md                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | locald-cli/src/handlers.rs checks for `./locald.toml`; locald-cli/src/run.rs uses `current_dir().join("locald.toml")`.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | OK                          | App Builder                                                                                                                                                                                   | Docs also mention other hierarchy files; not yet verified.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| CL-010: The interaction-mode docs’ command examples match the CLI surface (`start/ui/prune`).                                                                                                                                             | docs/design/user-interaction-modes.md; locald-docs/src/content/docs/concepts/user-interaction-modes.md                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | locald-cli/src/cli.rs exposes `up/monitor/dashboard/registry clean` but not `start/ui/prune` as top-level commands.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | Drift                       | All personas                                                                                                                                                                                  | C-001 resolved: docs should be updated to teach `up/monitor/registry clean`.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| CL-011: The daemon starts on system boot (or user login) and is “always-on”.                                                                                                                                                              | docs/design/user-interaction-modes.md; locald-docs/src/content/docs/concepts/user-interaction-modes.md                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | No `*.service` unit in repo (search `**/*.service`); CLI spawns daemon on-demand via `setsid locald server start` (locald-cli/src/utils.rs).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | Drift                       | App Builder / Operator                                                                                                                                                                        | This is Conflict Card C-002 (stop).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| CL-012: `locald init` points users at canonical next step (`locald up`).                                                                                                                                                                  | Strict single-canon decision (this audit) + canonical CLI vocabulary                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | locald-cli/src/init.rs prints: “Run `locald start` to launch your project.”                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | Drift                       | App Builder                                                                                                                                                                                   | Conflict Card C-005 (stop): pick the exact canonical next-step message.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| CL-013: `locald down` exists as a core command to stop services.                                                                                                                                                                          | docs/manual/features/cli.md; locald-docs/src/content/docs/reference/cli.md                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | No `down` command exists in locald-cli/src/cli.rs; no handler implementation found in locald-cli/src/handlers.rs.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Drift                       | App Builder                                                                                                                                                                                   | C-006 resolved: remove `down` from user-facing docs until implemented.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| CL-014: The CLI reference docs list the core command surface accurately and completely.                                                                                                                                                   | docs/manual/features/cli.md; locald-docs/src/content/docs/reference/cli.md                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | Both reference pages currently document `up`, `down`, `try`, `run` only; implementation supports `stop/restart/status/logs/monitor/dashboard/registry ...` (locald-cli/src/cli.rs; locald-cli/src/handlers.rs).                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | Drift                       | App Builder / Power User                                                                                                                                                                      | This is a “front door” doc: omissions create accidental discovery-only features and increase support load.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| CL-015: `locald stop` stops services for the current project by default, or a named service if provided.                                                                                                                                  | locald-docs/src/content/docs/concepts/user-interaction-modes.md (stop examples); locald-docs/src/content/docs/internals/architecture.md (“Graceful Shutdown”)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | CLI `Stop { name: Option<String> }` stops all services in `./locald.toml` when no name is provided; otherwise stops the named service; it resolves bare `name` via `project:service` from `locald.toml` (locald-cli/src/cli.rs; locald-cli/src/handlers.rs). Server stop sends configured signal (default SIGTERM) and enforces cleanup (locald-server/src/manager.rs; locald-server/src/service/exec.rs).                                                                                                                                                                                                                                                                         | Ambiguous                   | App Builder                                                                                                                                                                                   | Docs explain the shutdown mechanics well, but do not clearly teach the scoping rule (“current project via locald.toml”) as a user-facing contract.                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| CL-016: `locald logs -f <service>` streams logs (and supports non-follow snapshots).                                                                                                                                                      | locald-docs/src/content/docs/guides/backend-services.md                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | CLI defines `logs` with `--follow/-f` and optional service; handler resolves service name and streams logs; IPC supports follow vs snapshot via mode (locald-cli/src/cli.rs; locald-cli/src/handlers.rs; locald-core/src/ipc.rs).                                                                                                                                                                                                                                                                                                                                                                                                                                                  | OK                          | App Builder                                                                                                                                                                                   | Recommend teaching `locald logs -f` as canonical “tail -f” equivalent.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| CL-017: `locald status` shows the active URL for running services.                                                                                                                                                                        | locald-docs/src/content/docs/guides/dns-and-domains.md                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | CLI `status` prints a table including a URL column; service status includes optional `url` (locald-cli/src/handlers.rs; locald-core/src/ipc.rs).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | OK                          | App Builder                                                                                                                                                                                   | Status output quality (table width) is tracked as a UX improvement idea in docs.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| CL-018: `locald registry pin` retains a project and defaults it to autostart (enabled when the daemon starts).                                                                                                                            | locald-cli/src/cli.rs (help text: “Pin a project (keep it running)”); docs/rfcs/0085-workspace-support.md (“Use `locald registry pin` to keep them running.”)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | `registry pin` only sets `pinned = true` in the registry; it does not start services, and there is no separate `disabled`/`enabled` autostart state in the registry yet (locald-server/src/manager.rs: `registry_pin`; locald-core/src/registry.rs: `ProjectEntry { pinned }`).                                                                                                                                                                                                                                                                                                                                                                                                    | Drift                       | App Builder / Power User                                                                                                                                                                      | C-007 resolved: pin = retain + autostart-by-default (on daemon startup); add `registry disable` for retain-without-autostart.                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| CL-019: “Pinning” is a single coherent user concept (same word, same meaning) across dashboard + registry.                                                                                                                                | docs/manual/features/dashboard-ui.md (“This pinning is a dashboard UI concept; … distinct from registry/\"Always Up\" pinning”, plus “Unified Pinning” within the Deck section); locald-docs/src/content/docs/concepts/workspace.md (“Unified pinning: there’s one \"pin\" concept”); locald-docs/src/content/docs/getting-started/index.mdx (“The Deck: Pin services …”); docs/rfcs/0100-system-plane-and-unified-pinning.md (“Unified Pinning”); docs/manual/features/constellations-and-config.md (“Always Up … registry … always_up … Autostart”)                                                                                                                                                                                                     | Dashboard pinning is an in-memory UI list (`pinned: string[]`) that controls Deck tiles (locald-dashboard/src/lib/components/Rack.svelte; locald-dashboard/src/lib/components/Deck.svelte). Registry pinning is persistent and currently just `ProjectEntry.pinned: bool` (locald-core/src/registry.rs) toggled via IPC (locald-server/src/manager.rs).                                                                                                                                                                                                                                                                                                                            | Drift                       | All personas                                                                                                                                                                                  | This is a vocabulary collision: today “pin” refers to both “focus in UI” and “retain/autostart policy”. See Conflict Card C-008.                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| CL-020: Registry autostart policy is modeled as `always_up` (“Always Up”) and toggled via a pin icon / pin command.                                                                                                                       | docs/manual/features/constellations-and-config.md (“State… always_up flag”; “Autostart… always_up”); docs/manual/architecture/configuration.md (“Always Up… on daemon boot”); locald-docs/src/content/docs/internals/architecture/configuration.md (“Always Up… on daemon boot”); locald-docs/src/content/docs/internals/rfcs/constellations-and-config.md; docs/rfcs/0026-configuration-hierarchy.md (“locald pin … mark as always_up”)                                                                                                                                                                                                                                                                                                                  | No `always_up` field exists in Rust sources (search `locald-*/src/**/*.rs`); registry model is `ProjectEntry { pinned: bool }` (locald-core/src/registry.rs) and CLI surface is `locald registry pin/unpin` (locald-cli/src/cli.rs).                                                                                                                                                                                                                                                                                                                                                                                                                                               | Drift                       | All personas                                                                                                                                                                                  | Align docs to the approved model: registry policy is `pin` + `disable` (retain + enabled/disabled-on-boot), and dashboard uses “monitor” (C-008).                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| CL-021: CLI supports `locald service pin <name>` as an alias for the autostart policy toggle.                                                                                                                                             | docs/manual/features/constellations-and-config.md; locald-docs/src/content/docs/internals/rfcs/constellations-and-config.md (CLI bullet list includes `locald service pin <name>`)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | The `locald service` command group exists, but it does not include a `pin` subcommand (locald-cli/src/cli.rs: `Commands::Service { command: ServiceCommands }`; `ServiceCommands` includes `add`/`reset`; no `pin`). Closest implemented policy toggle remains `locald registry pin <path>` (locald-cli/src/cli.rs: `RegistryCommands::Pin`).                                                                                                                                                                                                                                                                                                                                      | Drift                       | Power User                                                                                                                                                                                    | Remove/replace the doc example to avoid inventing CLI; if per-service policy is desired later, introduce it explicitly as a new feature (and avoid overloading “pin”).                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| CL-022: Registry policy toggle commands are `locald pin/unpin` (top-level).                                                                                                                                                               | docs/rfcs/0026-configuration-hierarchy.md (“CLI Design: `locald pin <path                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | name>`…`locald unpin <path                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | name>`”)                    | Implemented CLI surface is `locald registry pin <path>` / `locald registry unpin <path>` (locald-cli/src/cli.rs). Strict single-canon decision forbids introducing aliases as “real” surface. | Drift                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Power User | Update RFC 0026 wording to `locald registry pin/unpin` and add `registry disable/enable` per the approved model. |
| CL-023: Dashboard uses a “monitor” concept/icon for Deck focus.                                                                                                                                                                           | C-008 decision (this audit): dashboard uses “monitor” and monitor icon; reserve “pin” for registry policy; docs/rfcs/0100-system-plane-and-unified-pinning.md (uses “monitor icon” and describes “Pin Mode”).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | Current implementation and docs still use “pin” language and a pin icon for Deck focus (docs/manual/features/dashboard-ui.md; locald-docs/src/content/docs/index.mdx; locald-docs/src/content/docs/getting-started/index.mdx; locald-docs/src/content/docs/concepts/workspace.md; locald-dashboard/src/lib/components/Deck.svelte imports `Pin` icon).                                                                                                                                                                                                                                                                                                                             | Drift                       | App Builder                                                                                                                                                                                   | This is a deliberate rename to remove the pin vocabulary collision; track as doc/UI remediation work, not a contract mismatch.                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| CL-024: The daemon implements RFC 0095 Mark‑Sweep GC (pinned/active/present/recent root set, TTL, periodic heartbeat, orphan sweep, and `registry audit`).                                                                                | docs/rfcs/0095-garbage-collector.md (Accepted; describes TTL + heartbeat + allowlist sweep + `registry audit`, and also references `locald admin gc` / `registry clean --force`); docs/manual/architecture/state-management.md (describes Mark‑Sweep GC + root set)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | Current implementation of cleanup is limited to `locald registry clean` removing missing **unpinned** registry entries and deleting the corresponding project state dir; no TTL root-set pruning, no heartbeat, no directory sweep for unknown-orphans, and no `registry audit` command (locald-server/src/manager.rs: `registry_clean`; locald-core/src/registry.rs: `prune_missing_projects`).                                                                                                                                                                                                                                                                                   | Drift                       | Operator / Power User                                                                                                                                                                         | C-009 resolved: treat Mark‑Sweep GC as planned; docs should downgrade manual claims to “planned” and document today’s `registry clean` behavior until remediation ships.                                                                                                                                                                                                                                                                                                                                                                                                                               |
| CL-025: `locald registry pin` is primarily a GC/retention-only feature (“prevent garbage collection”).                                                                                                                                    | docs/manual/architecture/state-management.md (“Pinning… prevent it from being garbage collected”); docs/rfcs/0095-garbage-collector.md (Pinned as a GC root)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | CLI help says pin keeps it running; code currently implements only `pinned: bool` and uses it during `registry_clean` to skip removal; no autostart behavior exists yet (locald-cli/src/cli.rs; locald-server/src/manager.rs; locald-core/src/registry.rs).                                                                                                                                                                                                                                                                                                                                                                                                                        | Drift                       | App Builder / Power User                                                                                                                                                                      | Model decision: pin = retain + autostart-by-default; disable = retain but don’t autostart. Docs must stop describing pin as GC-only.                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| CL-026: Docs still reference legacy top-level commands (`locald start`, `locald ui`, `locald prune`).                                                                                                                                     | locald-docs/src/content/docs/concepts/user-interaction-modes.md (actions include `locald start`, `locald ui`, `locald prune`); locald-docs/src/content/docs/internals/axioms/experience/01-zero-friction-start.md (mentions `locald prune` as a stale-registry cleanup mechanism); docs/manual/features/docker-integration.md ("Unified Lifecycle": `locald start`); docs/manual/features/constellations-and-config.md (registration implicit on `locald start`); docs/manual/architecture/state-management.md (registration when `locald up` or `locald start`); docs/rfcs/0004-architecture-daemon-cli.md (users run `locald start`); docs/rfcs/0069-host-first-execution.md (`locald up` or `locald start`)                                            | locald-cli/src/cli.rs exposes `up/monitor/dashboard/registry clean` but not `start/ui/prune` as top-level commands.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | Drift                       | All personas                                                                                                                                                                                  | Extend the C-001 remediation sweep beyond the interaction-modes pages: remove/translate legacy verbs everywhere they appear, keeping exactly one canonical vocabulary.                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| CL-027: Docs reference `locald register`, but the CLI does not expose an explicit `register` command.                                                                                                                                     | docs/manual/features/constellations-and-config.md (“Registration: `locald register .`…”); locald-docs/src/content/docs/internals/rfcs/constellations-and-config.md (same)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | No `register` command exists in locald-cli/src/cli.rs; registration is handled implicitly as part of implemented workflows (e.g., `locald up` handler registers the current project and can emit “Failed to register project…” on error in locald-cli/src/handlers.rs).                                                                                                                                                                                                                                                                                                                                                                                                            | Drift                       | App Builder / Power User                                                                                                                                                                      | Replace doc guidance with the canonical flow (“registration is implicit on `locald up`”), and avoid teaching command shapes that don’t exist.                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| CL-028: The canonical task-mode command name is consistent across docs (`locald exec` vs `locald run`).                                                                                                                                   | locald-docs/src/content/docs/guides/adhoc-tasks.md (uses `locald exec ...`); locald-docs/src/content/docs/guides/ci-automation.md (uses `locald ... exec ...`); docs/manual/features/cli.md (documents `locald run`); locald-docs/src/content/docs/reference/cli.md (documents `locald run`); locald-docs/src/content/docs/getting-started/index.mdx (uses `locald run ...`); docs/rfcs/0086-cli-surface-overhaul.md (specifies `locald exec` as renamed from `run`)                                                                                                                                                                                                                                                                                      | Implementation defines the subcommand as `exec` with a clap alias `run` (locald-cli/src/cli.rs: `Exec { .. }` with `#[command(alias = "run")]`).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | Drift                       | App Builder / Power User                                                                                                                                                                      | **C-010 decision:** Canonical docs teach **`locald run`** for spawning ephemeral tasks. **`locald exec` is reserved** for a future “Attach” operation (enter/attach to an already-running service/task) and should not appear in current user-facing docs until that RFC/feature exists. Remediation: consolidate docs to `run`, and plan a separate RFC that defines Attach semantics + dashboard visibility expectations.                                                                                                                                                                            |
| CL-029: `locald try` runs a local ad-hoc command, injects a dynamic `$PORT`, appends to a history file, and can interactively save it into `locald.toml`.                                                                                 | locald-docs/src/content/docs/guides/adhoc-tasks.md (describes try + save prompt); locald-docs/src/content/docs/reference/cli.md (describes “temporary, isolated environment” and shows `python:3.9` example); docs/manual/features/cli.md (shows `python:3.9` example)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | `Try` runs `sh -c <command>` locally, injects `PORT`, appends to `~/.local/share/locald/history` (or `$XDG_DATA_HOME/locald/history`), and prompts (TTY-only) to add an exec service to `locald.toml` (locald-cli/src/cli.rs; locald-cli/src/handlers.rs; locald-cli/src/try_cmd.rs; locald-cli/src/history.rs; locald-cli/src/service.rs).                                                                                                                                                                                                                                                                                                                                        | Drift                       | App Builder / Power User                                                                                                                                                                      | **C-011 decision:** `locald try` is canonically **host-executed** (not image-based). Remediation: remove “isolated environment” phrasing + the `python:3.9 ...` example from user docs; position image-based examples under `locald container run` (or equivalent) instead.                                                                                                                                                                                                                                                                                                                            |
| CL-030: `locald add last` exists as the “history recall → add to locald.toml” workflow, and is used by internal scripts/examples.                                                                                                         | docs/rfcs/0032-adhoc-execution.md (`locald add last` + history file path); scripts/verify-phase-33.sh; examples/adhoc-test/verify.sh; docs/manual/features/managed-data-services.md (mentions `locald add postgres`)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | `Add` exists and supports `locald add last` by reading the last history entry; otherwise it treats remaining args as a shell command to add as an exec service (locald-cli/src/cli.rs; locald-cli/src/handlers.rs; locald-cli/src/history.rs; locald-cli/src/service.rs).                                                                                                                                                                                                                                                                                                                                                                                                          | Drift                       | App Builder / Power User                                                                                                                                                                      | User-facing docs site does not teach `locald add` at all, while manual docs currently teach a non-existent `locald add postgres` form (the implemented syntax is `locald service add postgres ...`).                                                                                                                                                                                                                                                                                                                                                                                                   |
| CL-031: `locald try` injects the same environment variables as managed services (including `DATABASE_URL`).                                                                                                                               | locald-docs/src/content/docs/guides/adhoc-tasks.md (claims env like `$PORT` or `DATABASE_URL`); docs/manual/architecture/core.md (general claim that the daemon injects `PORT`, `DATABASE_URL`)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | `locald try` runs a host shell command and only injects `PORT` in the client (locald-cli/src/try_cmd.rs). It does not request service env from the daemon (no IPC call) and does not inject `DATABASE_URL`. Service env injection for things like `DATABASE_URL` is part of managed services and one-off tasks run via `locald run`/`Exec` using `IpcRequest::GetServiceEnv` (locald-cli/src/run.rs; locald-server/\* handles env).                                                                                                                                                                                                                                                | Drift                       | App Builder / Power User                                                                                                                                                                      | Clarify mental model: `try` is a host scratchpad with minimal injection (currently `PORT`), while `run`/task-mode uses daemon-provided service env (DB URLs, etc.).                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| CL-032: The manual’s “managed data services” guide teaches the correct CLI for adding Postgres.                                                                                                                                           | docs/manual/features/managed-data-services.md (claims `locald add postgres` creates the entry)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | Postgres add is implemented as `locald service add postgres <name> [--version <ver>]` (locald-cli/src/cli.rs `ServiceCommands::Add` + `AddServiceType::Postgres`; locald-cli/src/handlers.rs dispatches to `service::add_postgres`; locald-cli/src/service.rs writes config and starts project). There is no `locald add postgres` shortcut; `locald add` is specifically a shortcut for adding an `exec` service (locald-cli/src/cli.rs).                                                                                                                                                                                                                                         | Drift                       | App Builder                                                                                                                                                                                   | Update the manual to use `locald service add postgres db` (as the docs site already does) and keep `locald add ...` reserved for quick-add exec services / history recall.                                                                                                                                                                                                                                                                                                                                                                                                                             |
| CL-033: `locald ai schema` prints a JSON Schema derived from `LocaldConfig` for `locald.toml`.                                                                                                                                            | docs/manual/features/ai-usability.md (`locald ai schema` purpose + “Use schemars”); locald-docs/src/content/docs/internals/rfcs/ai-usability.md (same)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | CLI sends `IpcRequest::AiSchema` and prints the returned string (locald-cli/src/handlers.rs). Server derives `schemars::schema_for!(LocaldConfig)` and returns pretty JSON (locald-server/src/ipc.rs). IPC types are defined as string payloads (locald-core/src/ipc.rs).                                                                                                                                                                                                                                                                                                                                                                                                          | OK                          | Power User / Integrators                                                                                                                                                                      | Note: the manual page is phrased as “Design / We will introduce…”, but this specific subcommand is implemented today.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| CL-034: `locald ai context` outputs a Markdown “one-shot context dump” including system info, `locald.toml` contents, service status table, recent logs, and key env vars.                                                                | docs/manual/features/ai-usability.md (explicit Markdown format + content list); locald-docs/src/content/docs/internals/rfcs/ai-usability.md (same)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | CLI sends `IpcRequest::AiContext` and prints the returned string (locald-cli/src/handlers.rs). Server currently returns `serde_json::to_string_pretty(&manager.list().await)` (service status only) as `IpcResponse::AiContext(String)` (locald-server/src/ipc.rs; locald-core/src/ipc.rs). No Markdown formatting and no inclusion of config contents, logs, system info, or env vars.                                                                                                                                                                                                                                                                                            | Drift                       | Power User / Integrators                                                                                                                                                                      | Decide remediation direction: either downgrade docs to “current: JSON status dump” (and mark Markdown dump as planned), or implement the richer context contract (likely a new IPC message + log/config aggregation).                                                                                                                                                                                                                                                                                                                                                                                  |
| CL-035: `llms.txt` is generated and served at `https://docs.localhost/llms.txt`.                                                                                                                                                          | docs/manual/features/ai-usability.md (`llms.txt` Generation section); locald-docs/src/content/docs/internals/rfcs/ai-usability.md (same)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | No `scripts/generate-llms-txt*` exists, no `llms.txt` file exists in the repo, and the server sources do not reference an `llms.txt` endpoint (workspace search).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Drift                       | Integrators                                                                                                                                                                                   | Track as planned: add generator + embed/serve via docs server, or remove from “manual/current reality” until implemented.                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| CL-036: The daemon serves an embedded dashboard at `http://locald.localhost/` and embedded docs at `http://docs.localhost/`.                                                                                                              | docs/manual/features/dashboard-ui.md (explicit URLs); docs/manual/development/cross-surface-projects.md (“docs canonical URL is http://docs.localhost”); locald-docs/src/content/docs/getting-started/index.mdx (dashboard URL)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | Proxy routes `Host: docs.localhost` to `assets::handle_docs(...)` and `Host: locald.localhost` to `assets::handle_dashboard(...)` when no user service claims the domain (locald-server/src/proxy.rs).                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | OK                          | App Builder                                                                                                                                                                                   | Implementation also accepts `docs.local` / `locald.local` and `localhost` as fallbacks; docs should remain `.localhost` canonical per Decision 024.                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| CL-037: `locald --sandbox <name>` creates a sandbox directory under `~/.local/share/locald/sandboxes/<name>/` with `data/`, `config/`, `state/`, and a dedicated `locald.sock`, and sandboxed history lives at `.../data/locald/history`. | scripts/sandbox-run.sh (waits for `~/.local/share/locald/sandboxes/$SANDBOX/locald.sock`); examples/adhoc-test/verify.sh (reads `.../data/locald/history`); locald-e2e/src/harness.rs (sets XDG + socket for isolation)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | `setup_sandbox()` sets `XDG_DATA_HOME`/`XDG_CONFIG_HOME`/`XDG_STATE_HOME` to `.../sandboxes/<name>/{data,config,state}` and sets `LOCALD_SOCKET=.../locald.sock` + `LOCALD_SANDBOX_ACTIVE=1` (locald-cli/src/utils.rs). History uses `$XDG_DATA_HOME/locald/history` (locald-cli/src/history.rs).                                                                                                                                                                                                                                                                                                                                                                                  | OK                          | Power User / CI users                                                                                                                                                                         | This is a strong implicit contract for tests/scripting; recommend documenting it explicitly (or providing a `locald sandbox path` helper) if it’s intended to remain stable.                                                                                                                                                                                                                                                                                                                                                                                                                           |
| CL-038: Setting `LOCALD_PRIVILEGED_PORTS=false` disables privileged port binding for the daemon.                                                                                                                                          | scripts/verify-autostart.sh (exports `LOCALD_PRIVILEGED_PORTS=false` to avoid privileged ports)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | The server explicitly warns `LOCALD_PRIVILEGED_PORTS` is deprecated and ignored; sandbox mode (or global config) is the supported mechanism for `privileged_ports=false` (locald-server/src/config_loader.rs).                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | Drift                       | Contributor / CI users                                                                                                                                                                        | Either update the script to use sandbox/global config, or reintroduce env var behavior (but the code currently commits to deprecation).                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| CL-039: The daemon detects on-disk binary upgrades and self-restarts when idle (no active ephemeral tasks).                                                                                                                               | scripts/verify-update.sh (expects PID changes after rebuilding `locald` and running `locald up`)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | Server runs an upgrade watcher that checks `current_exe()` mtime every 5s and triggers `ShutdownReason::Restart` when it changes and `container_manager.active_count() == 0`; shutdown path then `execv()`s itself to restart (locald-server/src/lib.rs).                                                                                                                                                                                                                                                                                                                                                                                                                          | OK                          | Contributor / CI users                                                                                                                                                                        | This is powerful but subtle. If it’s intentional UX, docs should teach it (and clarify the “defers while ephemeral tasks are active” rule).                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| CL-040: Ephemeral containers support interactive/detached flags and TTY-style `-it` usage in docs.                                                                                                                                        | docs/manual/features/ephemeral-containers.md (example uses `locald container run -it ubuntu bash`); locald-docs/src/content/docs/guides/adhoc-tasks.md (claims interactive shells work via `-i`)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | CLI supports `locald container run` with `-i/--interactive` and `-d/--detached`, but there is no `-t` flag (locald-cli/src/cli.rs: `ContainerCommands::Run`). Server currently ignores `interactive`/`detached` and runs in foreground only (`TODO: Handle detached/interactive`) (locald-server/src/container.rs).                                                                                                                                                                                                                                                                                                                                                                | Drift                       | App Builder / Power User                                                                                                                                                                      | Docs should avoid `-t` entirely and should not imply true interactive shell support until stdin/pty/TTY wiring exists; keep examples to non-interactive commands and/or mark interactive support as planned.                                                                                                                                                                                                                                                                                                                                                                                           |
| CL-041: Managed Postgres data lives in the workspace under `.locald/…`, and `${services.<name>.url}` resolves to a URL that includes a password.                                                                                          | locald-docs/src/content/docs/guides/managed-services.md (“Data Persistence”: `.locald/data/postgres-<name>`; example shows `DATABASE_URL=postgres://postgres:password@127.0.0.1:<port>/postgres`)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | Postgres state is stored under XDG data dir by default (`ProjectDirs.data_dir()/postgres/<name>` with a `.locald/postgres/<name>` fallback) (locald-server/src/service/postgres.rs). `${services.<name>.url}` resolves via `Manager::get_service_field(..., "url")` to `postgres://postgres:postgres@localhost:<port>/postgres` (hardcoded password `postgres`) for Postgres services (locald-server/src/manager.rs: `get_service_field`). Separately, Postgres service controller metadata `url/connection_string` is `postgres://postgres@localhost:<port>/postgres` (no password) (locald-server/src/service/postgres.rs: `get_metadata`).                                      | Drift                       | App Builder                                                                                                                                                                                   | **C-012:** canonical storage is XDG, not workspace `.locald/data/...`. **C-013:** canonical connection string surface is `${services.<name>.url}` and the stable contract is **passwordless by default**. Remediation: update docs to stop inventing passwords; update implementation so `${services.<name>.url}` (and any surfaced metadata, if taught) is passwordless and consistent.                                                                                                                                                                                                               |
| CL-042: `sudo locald admin setup` grants `cap_net_bind_service` / uses `setcap` on the daemon to support privileged ports.                                                                                                                | locald-docs/src/content/docs/guides/dns-and-domains.md (claims admin setup grants `cap_net_bind_service`); locald-docs/src/content/docs/internals/axioms/environment/09-managed-networking.md (claims `setcap cap_net_bind_service=+ep` on `locald-server` applied via admin setup); locald-docs/src/content/docs/internals/architecture/security.md (describes capabilities + `setcap`); locald-docs/src/content/docs/internals/axioms/architecture/06-secure-privilege-separation.md (implies shim retains capabilities like `CAP_NET_BIND_SERVICE`); locald-docs/src/content/docs/internals/security.md (describes privileged-port strategy that implies setcap/caps behavior); docs/manual/architecture/security.md (discusses capabilities approach) | CLI handler explicitly says “we don’t setcap on locald anymore” as part of admin setup (locald-cli/src/handlers.rs). Server acquires privileged port listeners by requesting FDs from the setuid shim (FD passing) and falls back to direct bind when appropriate (locald-server/src/shim_client.rs; locald-server/src/proxy.rs).                                                                                                                                                                                                                                                                                                                                                  | Drift                       | App Builder / Operator                                                                                                                                                                        | Docs should describe the shim as the privileged boundary: admin setup installs/updates the shim and configures the host; privileged port binding is done via shim FD passing (not by granting `cap_net_bind_service` to the daemon).                                                                                                                                                                                                                                                                                                                                                                   |
| CL-043: `locald service reset <name>` reliably “factory-resets” a managed Postgres by deleting the Postgres state directory that the service is actually using.                                                                           | locald-docs/src/content/docs/guides/managed-services.md (“Data Persistence”: `.locald/data/postgres-<name>`; reset guidance implies data deletion)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | Postgres runtime state is stored under XDG data dir by default (`ProjectDirs.data_dir()/postgres/<name>` with a `.locald/postgres/<name>` fallback) (locald-server/src/service/postgres.rs). But reset currently deletes `.locald/services/postgres/<short_name>` (derived from `project:service` by splitting on `:`) (locald-server/src/manager.rs: `reset`), which does not match the XDG-first data dir.                                                                                                                                                                                                                                                                       | Drift                       | App Builder / CI users                                                                                                                                                                        | **C-012 resolution:** Canonical Postgres persistence is **XDG data dir**, and it **must participate in GC**. Remediation: docs must teach XDG location; implementation should make `reset` delete the XDG postgres dir for that service, and GC should be able to sweep this service data when the owning project is eligible for deletion.                                                                                                                                                                                                                                                            |
| CL-044: `locald trust` installs the locald CA into system trust (and may require sudo).                                                                                                                                                   | locald-docs/src/content/docs/guides/dns-and-domains.md (`locald trust`, and notes about sudo/permissions)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | `trust` uses `ca_injector` to install a CA and stores locald’s cert material under `~/.locald/certs`; on permission errors it suggests running `sudo locald trust` (locald-cli/src/trust.rs).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | Ambiguous                   | App Builder                                                                                                                                                                                   | Docs should be explicit about what “trust” does (CA generation + OS trust injection), when it needs sudo, and where local certs live (or declare the path as non-contractual if it may change).                                                                                                                                                                                                                                                                                                                                                                                                        |
| CL-045: Managed service state (including managed Postgres data under XDG) participates in garbage collection when projects are eligible for GC.                                                                                           | docs/manual/architecture/state-management.md (Mark‑Sweep GC story); docs/rfcs/0095-garbage-collector.md (Accepted design); **C-012 resolution** (this audit: Postgres is XDG-first and must be GC-managed)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | Current cleanup only removes project registry entries (missing + unpinned) and deletes the project container under the global projects state directory; it does not sweep managed Postgres data under XDG data dir (locald-server/src/manager.rs: `registry_clean`; Postgres uses `ProjectDirs.data_dir()/postgres/<name>` in locald-server/src/service/postgres.rs). Mark‑Sweep GC described in RFC 0095 is not implemented (see CL-024/C-009).                                                                                                                                                                                                                                   | Drift                       | App Builder / Operator / CI users                                                                                                                                                             | Requirement: any GC implementation (planned Mark‑Sweep) must include managed service state directories as swept resources; until then, `locald service reset` is the user-facing wipe tool and must delete the same XDG directory Postgres actually uses (CL-043).                                                                                                                                                                                                                                                                                                                                     |
| CL-046: `sudo locald admin setup` installs `locald-shim` into `~/.cargo/bin/locald-shim` (stable path) and the CLI expects it there.                                                                                                      | locald-docs/src/content/docs/internals/security.md (claims shim installed to `~/.cargo/bin/locald-shim`); docs/manual/architecture/resource-management.md (claims the shim is installed “next to the `locald` binary”)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | Admin setup installs the embedded shim **next to the `locald` executable** (same directory as `current_exe()`), at `<exe_dir>/locald-shim` (locald-cli/src/handlers.rs: `AdminCommands::Setup`). The runtime also locates a “privileged shim” via `locald_utils::shim::find_privileged()` rather than hard-coding `~/.cargo/bin` (locald-cli/src/handlers.rs: `AdminCommands::SyncHosts`).                                                                                                                                                                                                                                                                                         | Drift                       | App Builder / Operator                                                                                                                                                                        | Docs must converge on one install-location story. Current implementation is “shim is a sibling of the `locald` binary”, which is compatible with non-cargo installers and avoids relying on `~/.cargo/bin`.                                                                                                                                                                                                                                                                                                                                                                                            |
| CL-047: `locald admin sync-hosts` requires `sudo` and is a one-time setup step per domain.                                                                                                                                                | locald-docs/src/content/docs/guides/dns-and-domains.md (uses `sudo locald admin sync-hosts`); locald-docs/src/content/docs/guides/configuration-basics.md (says `sudo locald admin sync-hosts` updates `/etc/hosts` and is “only needed once per new domain”)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | CLI can be invoked without sudo; if not root, it attempts to exec the privileged shim to re-run itself as root (`LOCALD_SHIM_ACTIVE` guard + `locald_utils::shim::find_privileged()` + `exec shim admin sync-hosts ...`) (locald-cli/src/handlers.rs: `AdminCommands::SyncHosts`). It discovers domains by calling the daemon for status and collecting the `domain` fields from service statuses (locald-cli/src/handlers.rs: fetches `IpcRequest::Status`).                                                                                                                                                                                                                      | Ambiguous                   | App Builder                                                                                                                                                                                   | Doc intent (“update /etc/hosts”) is correct. Given the policy decision (assume `sudo locald admin setup`), user-facing docs should continue to show `sudo locald admin sync-hosts` and avoid teaching self-escalation as a current contract. Remaining contract question: is it truly “one-time per domain”, given the implementation derives the domain list from the daemon’s current view of services rather than a static configured list? If we want “one-time per domain” to be a stable promise, we should either persist a synced-domain set, or rephrase docs to “rerun when domains change”. |
| CL-048: Docs describe `locald-shim server start` as the wrapper used to start the daemon with elevated privileges/capabilities.                                                                                                           | locald-docs/src/content/docs/internals/security.md (describes `locald-shim server start` wrapper); locald-docs/src/content/docs/internals/axioms/architecture/06-secure-privilege-separation.md (references `server start` with retained capabilities); locald-docs/src/content/docs/internals/architecture.md (describes daemon spawn via `locald server start`)                                                                                                                                                                                                                                                                                                                                                                                         | The shim CLI has **no** `server start` command; it provides privileged helpers (`bind`, `bundle run`, `admin ...`) (locald-shim/src/main.rs). The daemon is started via `locald server start` (locald-cli/src/cli.rs) and requests privileged operations from the shim (FD passing, cgroup ops, etc.) (locald-server/src/shim_client.rs; locald-shim/src/main.rs). Manual intent is that the shim is a “leaf node” and does not exec the daemon (docs/manual/architecture/shim-management.md).                                                                                                                                                                                     | Drift                       | App Builder / Operator                                                                                                                                                                        | Docs should stop teaching `locald-shim server start`. Teach `locald up` as the user workflow and keep `locald server start` under advanced/testing. Describe the shim as an on-demand privileged helper, not a daemon launcher wrapper.                                                                                                                                                                                                                                                                                                                                                                |
| CL-049: `locald doctor` is a first-line readiness preflight and supports `--json` (CI gating) and `--verbose`.                                                                                                                            | locald-docs/src/content/docs/reference/cli.md (`locald doctor` section); locald-docs/src/content/docs/guides/ci-automation.md (`locald doctor --json`)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | Implemented: `locald doctor` exists with `--json`/`--verbose`, renders human or JSON report, and returns exit code `0` unless critical failures exist (locald-cli/src/cli.rs; locald-cli/src/doctor.rs; locald-utils/src/privileged/\*).                                                                                                                                                                                                                                                                                                                                                                                                                                           | OK                          | App Builder / Contributor / CI users                                                                                                                                                          | Remove from UCL (it is now documented in docs-site). Consider adding a short “Install/Setup” entry that frames `doctor` as the first step before `sudo locald admin setup` when privileged features aren’t working.                                                                                                                                                                                                                                                                                                                                                                                    |
| CL-050: `locald down` exists as a user-facing way to stop all services and the daemon.                                                                                                                                                    | locald-docs/src/content/docs/reference/cli.md (`locald down`: “Stops all running services and the daemon.”)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | There is no `Down` command in the CLI (locald-cli/src/cli.rs). The closest implemented lifecycle commands are `locald stop` (stops services only; does not shut down the daemon) and `locald server shutdown` (shuts down the daemon) (locald-cli/src/cli.rs; locald-cli/src/handlers.rs).                                                                                                                                                                                                                                                                                                                                                                                         | Drift                       | App Builder                                                                                                                                                                                   | Docs should remove `locald down` until implemented, or explicitly redefine it as an alias for a supported combination (e.g., `locald stop` + `locald server shutdown`) and implement that in the CLI.                                                                                                                                                                                                                                                                                                                                                                                                  |
| CL-051: `locald try` supports image-like arguments (e.g. `python:3.9`) and runs in a temporary isolated environment.                                                                                                                      | locald-docs/src/content/docs/reference/cli.md (`locald try` section + example `locald try python:3.9 ...`; claims “temporary, isolated environment”)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | `locald try` accepts arbitrary trailing args as a host command; the handler joins them and runs `sh -c <command>` on the host, injecting only `PORT` (locald-cli/src/cli.rs; locald-cli/src/handlers.rs; locald-cli/src/try_cmd.rs). There is no image pull/run behavior in `try`. “Isolation” is currently limited to using an available port and (optionally) prompting to save to `locald.toml`.                                                                                                                                                                                                                                                                                | Drift                       | App Builder / Power User                                                                                                                                                                      | Docs should align `try` to the implemented mental model (host scratchpad command with `PORT`, optional save prompt) and remove image examples. If image-based ad-hoc execution is desired, it should be a separate command (or `locald container run`).                                                                                                                                                                                                                                                                                                                                                |
| CL-052: `locald run <service> -- <cmd>` is the canonical name for “run one-off task in a service context”.                                                                                                                                | locald-docs/src/content/docs/reference/cli.md (`locald run` examples and description)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | The implemented subcommand name is `locald exec`, with `run` provided only as an alias (`#[command(alias = "run")]`) (locald-cli/src/cli.rs). This means `locald --help` will surface `exec` as the primary spelling even if docs teach `run`.                                                                                                                                                                                                                                                                                                                                                                                                                                     | Drift                       | App Builder / Power User                                                                                                                                                                      | Per prior vocabulary decisions, flip the primary spelling to `run` and keep `exec` as an alias (or at minimum make the help/UX show `run` as primary) to avoid creating two “canonical” tutorials.                                                                                                                                                                                                                                                                                                                                                                                                     |
| CL-053: Docs use a single canonical spelling for service-context tasks (either `run` or `exec`) across guides/reference.                                                                                                                  | locald-docs/src/content/docs/reference/cli.md (teaches `locald run`); locald-docs/src/content/docs/guides/ci-automation.md (examples use `locald ... exec <service> ...`)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | Implementation primary spelling is `exec` with `run` as an alias (locald-cli/src/cli.rs). Current docs are internally inconsistent: reference teaches `run` while CI guide uses `exec`.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | Drift                       | App Builder / CI users                                                                                                                                                                        | Choose one canonical spelling (per prior audit decisions: `run`), then update docs consistently and make CLI help align with the canonical spelling to reduce tutorial divergence.                                                                                                                                                                                                                                                                                                                                                                                                                     |
| CL-054: `locald run <shell command>` is the “hello world” ad-hoc experience when you don’t have a `locald.toml` yet.                                                                                                                      | locald-docs/src/content/docs/getting-started/index.mdx (uses `locald run 'python3 -m http.server $PORT'` with no config)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | The CLI does not have an ad-hoc `run <command>` mode. `run` is only an alias for `exec`, which requires a **service name** plus a command (`locald exec <service> <cmd...>`) (locald-cli/src/cli.rs). Ad-hoc execution of an arbitrary host command is implemented as `locald try <cmd...>` which runs `sh -c <command>` and injects only `PORT` (locald-cli/src/cli.rs; locald-cli/src/try_cmd.rs).                                                                                                                                                                                                                                                                               | Drift                       | App Builder                                                                                                                                                                                   | Fix getting-started to use `locald try "python3 -m http.server $PORT"` (or `locald try python3 -m http.server $PORT` if we want to avoid relying on `sh -c` quoting behavior), and reserve `run`/`exec` for service-context tasks once a `locald.toml` exists.                                                                                                                                                                                                                                                                                                                                         |
| CL-055: In CI, you can background `locald up` and later tear it down with `kill $PID`.                                                                                                                                                    | locald-docs/src/content/docs/guides/ci-automation.md (starts `locald --sandbox=test up &`, stores `PID`, tears down via `kill $PID`)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | `locald up` is a CLI client action that spawns/ensures the daemon and registers a project; it does not run as the daemon itself and returns once boot events complete (locald-cli/src/handlers.rs: `Commands::Up` streams boot events, then returns). Killing the `locald up` process will not reliably stop the daemon, and may do nothing if `up` already exited. The supported lifecycle controls are `locald server shutdown` (daemon) and `locald stop` (services) (locald-cli/src/cli.rs; locald-cli/src/handlers.rs).                                                                                                                                                       | Drift                       | Contributor / CI users                                                                                                                                                                        | Update CI docs to use explicit daemon lifecycle (`locald --sandbox=test server shutdown` for teardown) and, if needed, explicit service stop (`locald --sandbox=test stop`). Avoid PID-based teardown patterns that conflate the CLI client with the daemon process.                                                                                                                                                                                                                                                                                                                                   |
| CL-056: Privileged port binding relies on `setcap cap_net_bind_service=+ep` on `locald-server` (or the shim) as part of `locald admin setup`.                                                                                             | locald-docs/src/content/docs/internals/axioms/environment/09-managed-networking.md (claims `setcap cap_net_bind_service=+ep` on `locald-server` via admin setup); locald-docs/src/content/docs/internals/architecture/security.md (claims shim or main binary is granted cap via `setcap`); locald-docs/src/content/docs/internals/security.md (capability narrative); docs/manual/architecture/security.md (mentions capability approach as possible)                                                                                                                                                                                                                                                                                                    | The CLI explicitly states “we don't setcap on locald anymore, because the shim handles it” during admin setup (locald-cli/src/handlers.rs). The shim provides privileged port binding via a `bind` subcommand and FD passing (locald-shim/src/main.rs), and the daemon requests privileged listener FDs from the shim (locald-server/src/shim_client.rs; locald-server/src/proxy.rs). There is no `setcap` implementation in the codebase and no `CAP_NET_BIND_SERVICE` raising behavior in the shim (only commented-out constants) (locald-shim/src/main.rs).                                                                                                                     | Drift                       | App Builder / Operator                                                                                                                                                                        | Unify the story: privileged ports are handled by the setuid shim (FD passing), not by granting `cap_net_bind_service` to the daemon. If capabilities are still desired as a future path, mark them as planned and remove/soften “setcap via admin setup” claims from docs-site axioms/internals until implemented.                                                                                                                                                                                                                                                                                     |
| CL-057: Shim discovery supports `LOCALD_SHIM_PATH` overrides (used by `cargo run`) and falls back to searching `PATH`.                                                                                                                    | locald-docs/src/content/docs/internals/architecture/shim-management.md (describes discovery order including `LOCALD_SHIM_PATH` and PATH lookup); locald-docs/src/content/docs/internals/axioms/architecture/06-secure-privilege-separation.md (asserts env var overrides like `LOCALD_SHIM_PATH` are forbidden; shim must be sibling)                                                                                                                                                                                                                                                                                                                                                                                                                     | Shim discovery in code only checks for a sibling (and parent, for cargo test) `locald-shim` next to the current executable; it does **not** read `LOCALD_SHIM_PATH`, and it explicitly says PATH lookup is “not implemented yet” (locald-utils/src/shim.rs: `find` / `find_privileged`). The privileged readiness report also expects the shim next to the executable (locald-utils/src/privileged.rs).                                                                                                                                                                                                                                                                            | Drift                       | Contributor                                                                                                                                                                                   | Docs-site internals must converge: either implement `LOCALD_SHIM_PATH` + PATH lookup (and define the security model), or remove these claims and standardize on “sibling-only discovery” (which aligns with the axiom).                                                                                                                                                                                                                                                                                                                                                                                |
| CL-058: Shim verification happens “on every startup” using version checks in debug builds and cryptographic hash checks in release builds.                                                                                                | locald-docs/src/content/docs/internals/security.md (debug builds: version match; release: hash match; “verifies on every startup”); locald-docs/src/content/docs/internals/architecture/security.md (version handshake)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | The CLI verifies the shim for most commands (skips `admin setup` + `doctor`) by comparing on-disk shim bytes against embedded shim bytes and exits with remediation if it differs (locald-cli/src/main.rs; locald-cli/src/utils.rs `verify_shim`; locald-utils/src/shim.rs `verify_integrity`). The readiness report supports either embedded-byte comparison or a `--shim-version` comparison depending on config, but the current CLI wires embedded bytes as the expected value (locald-cli/src/doctor.rs; locald-utils/src/privileged.rs). There is no cryptographic hash check distinct from byte comparison, and this verification is performed by the CLI (not the daemon). | Drift                       | App Builder / Contributor                                                                                                                                                                     | Update docs to describe the real contract: CLI-side integrity check via embedded shim bytes (and the `doctor` report). If “daemon-side version handshake” is desired, implement it explicitly and document when privileged features degrade vs hard-fail.                                                                                                                                                                                                                                                                                                                                              |
| CL-059: Upgrading `locald` via `cargo install` does not require rerunning `sudo locald admin setup` because the shim remains valid/usable across upgrades.                                                                                | locald-docs/src/content/docs/internals/security.md (“When you update locald via cargo install, the shim remains untouched… without needing to run sudo again.”)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | `locald` treats the shim as build-coupled: if the installed shim bytes do not match the embedded shim bytes for the current `locald`, most CLI commands will fail fast and instruct `sudo locald admin setup` (locald-cli/src/utils.rs `verify_shim`; locald-cli/src/main.rs). Admin setup exists specifically to reinstall/update the embedded shim next to the current executable (locald-cli/src/handlers.rs).                                                                                                                                                                                                                                                                  | Drift                       | App Builder / Contributor                                                                                                                                                                     | Docs should teach “upgrading locald may require rerunning `sudo locald admin setup` to refresh the privileged helper,” and explain that this is intentional safety (build-coupled shim). If we want “no sudo after upgrades,” then shim compatibility must be decoupled and versioned as a stable protocol (and implemented accordingly).                                                                                                                                                                                                                                                              |
| CL-060: “Transparent escalation” means users don’t need to manually use `sudo` for commands that need privilege; the CLI auto re-execs via the shim seamlessly.                                                                           | locald-docs/src/content/docs/internals/axioms/architecture/06-secure-privilege-separation.md (Transparent Escalation principle); locald-docs/src/content/docs/internals/security.md (debug port flow says CLI executes `locald-shim debug port ...`)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | `locald debug port <n>` _does_ attempt to exec the shim when not root, but it uses `get_configured_shim()` which may trigger `sudo` to repair permissions and can fail if the shim is not installed/configured (locald-cli/src/debug.rs; locald-utils/src/shim.rs). Other privilege-requiring flows vary: `admin sync-hosts` attempts shim escalation but will hard-fail if shim isn’t configured (locald-cli/src/handlers.rs). This is not “no sudo ever”; it’s “no repeated sudo once the shim is configured,” and even then escalation can fail and fall back to partial visibility (port debug) or error (sync-hosts).                                                         | Drift                       | App Builder / Operator                                                                                                                                                                        | Given the policy decision (assume `sudo locald admin setup`), user-facing docs should stop presenting “transparent escalation” as a UX promise for now. Treat shim re-exec as an internal implementation detail; keep the canonical remediation path as `locald doctor` → `sudo locald admin setup`.                                                                                                                                                                                                                                                                                                   |
| CL-061: `sudo locald admin setup` installs `locald-shim` to `~/.cargo/bin/locald-shim` (stable path) and other commands invoke it from there.                                                                                             | locald-docs/src/content/docs/internals/security.md (claims shim installed to `~/.cargo/bin/locald-shim`); locald-docs/src/content/docs/internals/architecture/shim-management.md (describes PATH lookup; implies shim may be in PATH)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | Admin setup installs the embedded shim next to the current `locald` executable as `<exe_dir>/locald-shim` (locald-cli/src/handlers.rs). Shim discovery prefers sibling/parent next to the executable and does not implement PATH lookup (locald-utils/src/shim.rs).                                                                                                                                                                                                                                                                                                                                                                                                                | Drift                       | Contributor / Operator                                                                                                                                                                        | Standardize docs on “sibling install/discovery” (or implement PATH-based discovery and document its security constraints). Remove `~/.cargo/bin` specificity unless it is an explicit supported installer contract.                                                                                                                                                                                                                                                                                                                                                                                    |

## 7) Undocumented Capability Ledger (Code → Doc Proposal)

| Capability                                                                            | Where it lives                                                           | Current discoverability                                                                                                      | Persona fit                                                       | Proposed doc placement              | Proposed framing                                                                                                                 | Risks                                                                                                                                                          |
| ------------------------------------------------------------------------------------- | ------------------------------------------------------------------------ | ---------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------- | ----------------------------------- | -------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------ |
| UCL-001: Sandbox mode (`--sandbox`) isolates XDG dirs and forces socket override.     | locald-cli/src/cli.rs; locald-cli/src/utils.rs                           | Low (flag exists, not surfaced in README/design docs)                                                                        | Power User / CI users                                             | “Troubleshooting” + “CLI Reference” | Explain: sandbox = isolated XDG dirs + separate socket; good for tests and safe experimentation.                                 | Users may assume sandbox is required for all use; must clarify optional vs recommended.                                                                        |
| UCL-002: `LOCALD_SOCKET` env var is only allowed when `LOCALD_SANDBOX_ACTIVE=1`.      | locald-utils/src/ipc.rs                                                  | Very low (implicit contract)                                                                                                 | Power User / Integrators                                          | “Environment Variables” reference   | Document safety boundary: prevents pointing at arbitrary sockets outside sandbox.                                                | Breaks bespoke scripts that set LOCALD_SOCKET without sandbox; must explain how to fix.                                                                        |
| UCL-003: Shim auto-fix gate via `LOCALD_SHIM_AUTO_FIX=1`.                             | locald-cli/src/utils.rs (`try_auto_fix_shim`)                            | Very low                                                                                                                     | App Builder                                                       | “Install/Setup” + “Troubleshooting” | “Optional: allow interactive sudo auto-repair when shim is outdated.”                                                            | Surprising sudo prompts; must keep opt-in message.                                                                                                             |
| UCL-004: `/tmp/locald.log` is used for daemon stdout/stderr.                          | locald-cli/src/utils.rs (`spawn_daemon`)                                 | Low                                                                                                                          | Power User                                                        | “Troubleshooting”                   | “If daemon fails to start, check /tmp/locald.log”                                                                                | `/tmp` is ephemeral; path might change later.                                                                                                                  |
| UCL-005: AI integration commands exist (`locald ai schema`, `locald ai context`).     | locald-cli/src/cli.rs                                                    | Low                                                                                                                          | Power User / Integrators                                          | “CLI Reference”                     | “Schema export and runtime context for tooling.”                                                                                 | If unstable, must label experimental.                                                                                                                          |
| UCL-006: Test/automation-friendly daemon lifecycle commands (`locald server start     | shutdown`+`locald ping`).                                                | locald-cli/src/cli.rs; locald-cli/src/utils.rs (`ensure_daemon_running` uses Ping); scripts/check; locald-e2e/src/harness.rs | Low (used by scripts/tests; not taught as a user-facing workflow) | Contributor / CI users              | “Contributing / Testing” + “CLI Reference” (advanced)                                                                            | “How to spawn/stop a sandboxed daemon deterministically and verify IPC is healthy.”                                                                            | If taught broadly, users may bypass the intended `locald up` workflow; keep under advanced/testing guidance. |
| UCL-007: Override proxy bind ports via env (`LOCALD_HTTP_PORT`, `LOCALD_HTTPS_PORT`). | locald-server/src/lib.rs; scripts/verify-install-assets.sh               | Very low                                                                                                                     | Contributor / CI users                                            | “Testing / CI” + “Troubleshooting”  | “Run locald without privileged ports by binding to ephemeral ports; useful in CI.”                                               | Must be scoped as test-only to avoid fragmenting the standard `docs.localhost` UX story.                                                                       |
| UCL-008: Daemon auto-restarts itself on binary upgrade (when idle).                   | locald-server/src/lib.rs (`watch_for_upgrade`); scripts/verify-update.sh | Very low                                                                                                                     | Contributor                                                       | “Contributing / Dev Workflow”       | “Rebuild `locald`, and the running daemon will restart itself once it sees the new binary (unless ephemeral tasks are running).” | If this ever changes, developer workflows/scripts will break; either document as best-effort or add an explicit `locald server restart` story for determinism. |

## 8) Persona Toolchains (Unification Check)

Personas found (non-provisional):

- App Builder / Power User / Contributor / Platform Engineer (docs/design/personas.md)

### App Builder golden path (v0, based on observed CLI)

- Install → configure → run → debug → ship
  - Install: obtain the `locald` binary (README.md describes CI/verification workflows; install doc is Stage 0 in docs/rfcs/0039-installation-and-updates.md).
  - Configure: `locald init` to create `locald.toml` (locald-cli/src/init.rs) or hand-write minimal `locald.toml` (locald-core/src/config/mod.rs).
  - Run: `locald up` (locald-cli/src/handlers.rs).
  - Debug: `locald status`, `locald logs --follow`, `locald dashboard`, `locald monitor` (locald-cli/src/cli.rs).
  - Privileged setup when needed: `sudo locald admin setup` (README.md; locald-cli/src/cli.rs).

Feature islands (initial):

- `--sandbox` and env-var constraints likely useful for CI and safe testing but not taught (UCL-001/UCL-002).
- `locald ai *` commands exist but are not referenced in docs (UCL-005).

Multi-writer / multi-authority risks (initial):

- Command naming drift (`start` vs `up`, `ui` vs `monitor`, `prune` vs `registry clean`) risks creating two competing “canonical” tutorials.

Boundary violations encouraged by examples (initial):

- `LOCALD_SOCKET` cannot be set outside sandbox; external scripts may conflict if not documented (UCL-002).

## 9) Documentation Proposals (RFC-style)

These are doc proposals that do **not** require resolving C-001.

- **P-001: Sandbox & IPC Environment Contract**

  - Placement: “CLI Reference” + “Troubleshooting” + “Environment Variables”
  - Outline:
    - What `--sandbox` does
    - What paths change (XDG dirs, socket)
    - Why `LOCALD_SOCKET` is forbidden without sandbox
    - Examples: `locald --sandbox smoke up`, `LOCALD_SANDBOX_ACTIVE=1 LOCALD_SOCKET=...`
  - Key messages: sandbox is optional; `LOCALD_SOCKET` is a safety boundary.
  - Risks/tradeoffs: users might overuse sandbox and fragment state.

- **P-002: Privileged Shim Lifecycle & Self-Repair Policy**

  - Placement: “Install/Setup” + “Troubleshooting”
  - Outline:
    - When the shim is required
    - How verification works and what errors look like
    - Manual fix: `sudo locald admin setup`
    - Optional auto-fix: `LOCALD_SHIM_AUTO_FIX=1`
  - Key messages: “no surprises” default; auto-repair is explicit opt-in.
  - Risks/tradeoffs: avoid encouraging always-on sudo usage.

- **P-003: Daemon bootstrap + Where logs go**

  - Placement: “Getting Started” + “Troubleshooting”
  - Outline:
    - When the daemon auto-starts
    - Foreground vs background server (`locald server start`)
    - Log location (`/tmp/locald.log`) and how to interpret failures
  - Risks/tradeoffs: `/tmp/locald.log` may be platform-specific.

- **P-004: Canonical CLI Vocabulary (start/ui/prune → up/monitor/registry clean)**

  - Placement: “Getting Started” + “Concepts: Interaction Modes” + “CLI Reference”
  - Outline:
    - Canonical verbs (Up/Monitor/Dashboard/Registry)
    - A short translation table for legacy terms (start/ui/prune)
    - A single recommended golden path per persona
  - Key messages: one canonical command set; keep legacy terms as “recognized history” (or document as deprecated if/when aliases exist).
  - Risks/tradeoffs: if aliases are later added, docs must remain explicit about deprecation.

- **P-005: Daemon Lifecycle (Current Reality + Remediation Plan)**

  - Placement: “Concepts: Interaction Modes” + “Getting Started” + “Install/Setup”
  - Teach _now_ (current contract):
    - Daemon is typically started **on-demand** by the CLI.
    - If you want it running ahead-of-time, use an explicit command (`locald server start`), but most users won’t need to.
  - Teach _later_ (planned remediation):
    - Add first-class OS-managed autostart where it makes sense:
      - Linux: a user-level `systemd` unit (and/or a generator/installer under `locald admin ...`).
      - macOS: `launchd` agent.
      - Windows: (future) service story or a documented equivalent.
    - Explicitly position OS integration as “optional convenience”, not required for correctness.
  - Key messages: “services start when you run `locald up`, and daemon autostart is currently manual.”

- **P-006: CLI Taxonomy + Alias/Deprecation Policy**

  - Placement: “CLI Reference” + a short “Glossary” box in Getting Started.
  - Goal: remove ambiguity about whether a command acts on the **current project** (current directory / `locald.toml`) vs the **locald system plane** (daemon/registry).
  - Proposed taxonomy (teach as mental model):
    - **Project plane**: verbs that act on the project in the current directory.
      - `locald up` / `locald status` / `locald logs` / `locald stop` / `locald restart`.
      - (Planned) `locald down` may be added later as a more ergonomic “stop project” command; until implemented it should not appear in user-facing docs.
    - **System plane**: verbs that manage the daemon itself.
      - `locald server start|shutdown|restart` (and optionally a nicer `locald daemon ...` alias later).
    - **Registry plane**: verbs that manage known projects and pinning.
      - `locald registry list|pin|unpin|clean` (where `clean` is explicitly described as “prune missing projects”).
    - **UI plane**:

- **P-007: Managed Services Persistence + Reset + GC Contract (Postgres)**

  - Placement: “Guides: Managed Services” + “Architecture: State Management” (and a short callout in Getting Started)
  - Teach _now_ (current contract):
    - Postgres persistence is **XDG-first** (C-012 resolution).
    - `locald service reset <name>` is the explicit “wipe this DB” tool (but must be described truthfully until implementation matches).
    - `${services.<name>.url}` is the canonical way to plumb connection strings (and must be consistent with any other surfaced URL/metadata).
  - Teach _later_ (planned remediation):
    - When Mark‑Sweep GC ships, managed service state (including XDG Postgres data) participates in GC sweep for non-root-set projects (CL-045).
  - Key messages: one canonical storage location, one canonical connection string source, and a clear “reset vs GC” mental model.
    - `locald dashboard` (web UI).
    - `locald monitor` (TUI).
  - Policy decision: **strict single-canon**
    - Do **not** add aliases like `start/ui/prune`.
    - Use **canonical spellings only** in docs, examples, screenshots, and team communication.
    - If we want to help muscle-memory transition, prefer non-binding affordances:
      - Help text that includes synonyms as _descriptions_ (“clean = prune missing projects”).
      - Optional “did you mean …” suggestions on unknown commands (without accepting the alias).
  - Policy decision: **privileged setup is assumed (for now)**
    - User-facing docs assume: `sudo locald admin setup` has been run.
    - Do not teach “sudoless” workflows or “transparent escalation” as a promised contract yet.
    - If a privileged feature isn’t working, the canonical remediation remains: `locald doctor` → `sudo locald admin setup`.
  - Output rule-of-thumb: default output should be “what changed / what’s actionable”, not full expanded inventories unless requested.

## 10) Conflicts Requiring Decision (STOP List)

### Conflict Card C-001

- **Conflict ID:** C-001
- **Claim (docs/RFCs say):**
  - docs/design/user-interaction-modes.md teaches `locald start`, `locald ui`, and `locald prune` as user-facing commands.
- **Observed reality (code does):**
  - The CLI implements `locald up`, `locald monitor`, `locald dashboard`, and `locald registry clean` (locald-cli/src/cli.rs; locald-cli/src/handlers.rs).
  - RFC 0086 proposes `locald up` / `locald monitor` / `locald registry clean` (docs/rfcs/0086-cli-surface-overhaul.md).
- **Why it matters (which persona breaks, what failure occurs):**
  - App Builder / Power User: Following the interaction-mode doc produces “unknown command” failures or sends users down the wrong workflow.
  - Contributor: docs become untrustworthy; onboarding and support load increases.
- **Candidate resolutions (do not pick yet):**
  1. Treat `up/monitor/registry clean` as canonical and update interaction-mode docs accordingly.
  2. Add CLI aliases (`start`→`up`, `ui`→`monitor`, `prune`→`registry clean`) and keep docs as-is (or document both).
- **Resolution:** Canonical docs teach **`locald up` / `locald monitor` / `locald registry clean`**.

### Conflict Card C-002

- **Conflict ID:** C-002
- **Claim (docs/RFCs say):**
  - Daemon Mode is “always-on”; it starts on system boot (or user login) (docs/design/user-interaction-modes.md; locald-docs/src/content/docs/concepts/user-interaction-modes.md).
- **Observed reality (code does):**
  - The daemon is commonly started _on-demand_ by the CLI via `setsid locald server start` (locald-cli/src/utils.rs: `spawn_daemon`, `ensure_daemon_running`).
  - No system service/unit file for the daemon is present in-repo (search: `**/*.service`).
- **Why it matters (which persona breaks, what failure occurs):**
  - App Builder: expects `locald status`/dashboard to work “because the daemon is always on”, but the reality is “daemon starts when you run locald (or you must start it)”.
  - Operator: unclear whether to manage `locald` via OS service manager (systemd/launchd) vs via `locald server start`.
- **Resolution:** Teach the daemon as **on-demand / manual today**.
  - The daemon is typically started by the CLI as needed.
  - The docs should say the daemon will start your _services_ when you run `locald up`, but daemon autostart at boot/login is **not** the current reality.
  - Add a remediation plan to implement OS-managed autostart (systemd/launchd/etc.) and document it as an optional convenience.

### Conflict Card C-003

- **Conflict ID:** C-003
- **Claim (docs/RFCs say):**
  - Default domain suffix is `.localhost` (docs/manual/vision.md; docs/agent-context/decisions.md Decision 024).
- **Observed reality (code does):**
  - `locald init` prompts for “Local Domain (optional)” with a default of `{project_name}.local` (locald-cli/src/init.rs). If the user hits enter, this becomes an explicit `.local` domain, overriding `.localhost` defaults.
  - Other surfaces default to `.localhost` (e.g. locald-cli/src/service.rs uses `{project_name}.localhost` when creating a config).
- **Why it matters (which persona breaks, what failure occurs):**
  - App Builder: ends up with mixed domains across projects; undermines “predictable URLs” and makes docs harder to follow.
  - Team communication: “go to foo.localhost” becomes unreliable if a project was initialized with `.local`.
- **Candidate resolutions (do not pick yet):**
  1. Change `locald init` to default to `{project_name}.localhost`.
  2. Change `locald init` to default to empty (None), relying on runtime defaults (`{name}.localhost`).
  3. Keep `.local` default for legacy reasons and update docs to treat `.localhost` as recommended-but-not-default (not preferred under strict single-canon).
- **Resolution:** Default domain suffix is **always `.localhost` for now**.
  - `.local` is legacy/retired due to mDNS.
  - Other suffixes (e.g. `.dev`) must be explicit opt-in, because they may collide with real domains.
  - Follow-up implication: `locald init` should not default to `.local`.

### Conflict Card C-004

- **Conflict ID:** C-004
- **Claim (docs/RFCs say):**
  - `locald config show --provenance` explains where _each resolved value_ came from across Global/Context/Workspace/Project layers (docs/rfcs/0026-configuration-hierarchy.md, “Provenance & Visibility”).
- **Observed reality (code does):**
  - `locald config show --provenance` currently prints the global config path and a debug dump of the global config struct (locald-cli/src/handlers.rs), but does not emit per-key provenance and does not present the full layering model from RFC 0026.
- **Why it matters (which persona breaks, what failure occurs):**
  - Power User: cannot answer “where did this value come from?” which is exactly the purpose of provenance; config feels magical.
  - Contributor: RFC 0026 is Stage 3 (law) and is currently overpromising relative to the CLI behavior.
- **Candidate resolutions (do not pick yet):**
  1. Upgrade `locald config show --provenance` to match RFC 0026’s contract (per-key provenance, all layers).
  2. Narrow the contract: rename/scope the current output to “global config dump”, and move provenance tooling to a different command/flag.
- **Smallest question to user (one decision):**

  - Should `locald config show --provenance` be treated as a **hard contract** we must implement (per RFC 0026), or should we **revise the contract** and treat current output as sufficient for now?

- **Resolution:** Capture the **spirit** of RFC 0026 (visibility into config layering/provenance) without treating the specific output format/examples as binding.
  - Follow-up implication: the Stage 3 law should be updated to reflect the current/desired UX once we pick an implementation approach.

### Conflict Card C-005

- **Conflict ID:** C-005
- **Claim (docs/RFCs say):**
  - We have strict single-canon vocabulary: project lifecycle is `locald up` (not `start`).
- **Observed reality (code does):**
  - After writing `locald.toml`, `locald init` prints: `Run \`locald start\` to launch your project.` (locald-cli/src/init.rs).
- **Why it matters (which persona breaks, what failure occurs):**
  - App Builder: immediate “unknown command” / confusion loop if they try to follow the instruction.
  - Social coordination: introduces a second dialect right at the front door.
- **Candidate resolutions (do not pick yet):**
  1. Change the message to: `Run \`locald up\` to launch your project.`
  2. Change the message to a slightly more guided form: `Next: run \`locald up\`. (Tip: \`locald dashboard\` opens the web UI.)`
- **Smallest question to user (one decision):**

  - Should the `locald init` success message be the minimal `Run \`locald up\`…`, or the guided version that also mentions `dashboard`?

- **Resolution:** Use the **slightly guided** message.
  - Recommended phrasing: `Next: run \`locald up\`. (Tip: \`locald dashboard\` opens the web UI.)`

### Conflict Card C-006

- **Conflict ID:** C-006
- **Claim (docs/RFCs say):**
  - `locald down` is a core command (docs/manual/features/cli.md; locald-docs/src/content/docs/reference/cli.md).
- **Observed reality (code does):**
  - The CLI does not currently define or handle a `down` command (locald-cli/src/cli.rs; locald-cli/src/handlers.rs).
- **Why it matters (which persona breaks, what failure occurs):**
  - App Builder: follows the CLI reference and immediately hits “unknown command”.
  - Strict single-canon: doc-only commands create dialect-by-documentation.
- **Candidate resolutions (do not pick yet):**
  1. Remove `locald down` from user-facing docs until it is implemented (preferred for correctness).
  2. Keep `locald down` in docs but explicitly label it as “planned / not yet implemented” (preferred if we want to socialize the ideal surface early).
  3. Implement `locald down` soon and keep docs as-is.
- **Smallest question to user (one decision):**

  - Should user-facing docs **remove** `locald down` until it exists, or keep it as **planned-but-not-yet**?

- **Resolution:** Remove `locald down` from user-facing docs until it is implemented.
  - Keep the intent as a planned remediation: add `locald down` soon.
  - When we implement it, capture the work as an RFC (CLI + docs updates together) so the docs remain coherent.

### Conflict Card C-007

- **Conflict ID:** C-007
- **Claim (docs/RFCs say):**
  - The CLI help for `locald registry pin` says it will “keep it running” (locald-cli/src/cli.rs).
- **Observed reality (code does):**
  - `locald registry pin` only toggles a `pinned` boolean in the registry; it does not start or keep services running (locald-server/src/manager.rs: `registry_pin`; locald-server/src/ipc.rs handles `IpcRequest::RegistryPin`).
- **Why it matters (which persona breaks, what failure occurs):**
  - App Builder: expects pinning to (re)start or preserve uptime; instead, nothing happens.
  - Power User: unclear whether “pinned” is an availability contract or just a retention/GC contract.
- **Candidate resolutions (do not pick yet):**

  1. Treat pinning as **retention only** (prevents cleanup/GC), and update help text + docs to match.
  2. Upgrade pinning to also mean **autostart/keep running**, and implement the missing behavior.

- **Smallest question to user (one decision):**

  - Should `locald registry pin` mean **retention-only** (prevents GC/cleanup), or should it mean **autostart/keep running** as well?

- **Resolution:** Two-state policy.

  - `locald registry pin` means **retain** (“don’t clean up”) and defaults to **enabled on daemon startup** (autostart when the daemon starts).
  - `locald registry disable` (new concept/command) means **retain** but **do not boot** (no autostart).
  - Current code reality: there is only `pinned: bool` in the registry (locald-core/src/registry.rs) and `registry_pin` / `registry_unpin` only toggle that flag (locald-server/src/manager.rs). No `disabled`/`enabled` autostart state exists yet.

  ### Conflict Card C-008

  - **Conflict ID:** C-008
  - **Claim (docs/RFCs say):**
    - Some docs imply _two different_ pin concepts:
      - Dashboard pinning (Deck focus) is distinct from registry/“Always Up” pinning (docs/manual/features/dashboard-ui.md; docs/manual/features/constellations-and-config.md).
    - Other docs use language that can be read as _one_ pin concept:
      - “Unified pinning: there’s one ‘pin’ concept; pin what you want to focus on.” (locald-docs/src/content/docs/concepts/workspace.md).
  - **Observed reality (code does):**
    - Dashboard “pin to Deck” is a UI-only concept (`pinned: string[]`) used to decide Stream vs Deck layout (locald-dashboard/src/lib/components/Rack.svelte; locald-dashboard/src/lib/components/Deck.svelte).
    - Registry pinning is persistent project metadata (`ProjectEntry.pinned: bool`) and (per C-007 resolution) is intended to drive autostart/retention policy (locald-core/src/registry.rs; locald-server/src/manager.rs).
  - **Why it matters (which persona breaks, what failure occurs):**
    - App Builder: sees “pin” in UI and CLI and reasonably assumes the same behavior; gets confused when “pinning” in one place doesn’t affect the other.
    - Power User: can’t build reliable mental models or automation when the same term names different state machines.
  - **Smallest question to user (one decision):**

    - Should the product **reserve “pin” for registry policy** (retain + enabled/disabled-on-boot) and rename the dashboard action/state (e.g. “focus”, “deck”, “tile”), or should we keep **two different ‘pin’ meanings** and rely on docs/UI copy to distinguish them?

  - **Resolution:** Reserve **“pin”** for registry policy.

    - Dashboard UI concept should be renamed to **“monitor”** (use the monitor icon in the sidebar/inline instead of a pin icon).
    - Docs should treat dashboard “monitoring” as “focus this in the Deck/Stream”, and treat registry `pin/disable` as boot/retention policy.

    ### Conflict Card C-009

    - **Conflict ID:** C-009
    - **Claim (docs/RFCs say):**
      - RFC 0095 (Accepted) describes a Mark‑Sweep GC with:
        - Root set = pinned OR active OR present OR recent (TTL)
        - Sweep = delete orphaned `projects/` dirs not allowlisted
        - Automation = startup sweep + 24h heartbeat
        - Manual = `locald registry clean` (or `locald admin gc`) and `locald registry audit`
      - The manual echoes Mark‑Sweep GC semantics (docs/manual/architecture/state-management.md).
    - **Observed reality (code does):**
      - `locald registry clean` only removes registry entries when the project directory is missing _and not pinned_, and deletes the corresponding state container dir. There is no TTL window, no root-set computation beyond “missing + not pinned”, no orphan sweep, and no `registry audit` (locald-server/src/manager.rs: `registry_clean`; locald-core/src/registry.rs: `prune_missing_projects`).
    - **Why it matters (which persona breaks, what failure occurs):**
      - Operator/Power User: expects disk usage to self-heal over time; instead cleanup is manual and only handles a narrow “missing dir” case.
      - App Builder: docs set expectations about safety/TTL and “recent” retention that do not exist.
    - **Candidate resolutions (do not pick yet):**
      1. Treat RFC 0095 as **planned**: keep it as Accepted design, but mark manual/docs as “not implemented yet” and describe only current `registry clean` behavior.
      2. Treat RFC 0095 as **current contract**: prioritize implementing TTL + heartbeat + sweep + audit soon (and then update docs to match exact behavior).
    - **Smallest question to user (one decision):**

      - For the User Programming Model docs _now_, should we describe GC as **planned** (document today’s `registry clean` only), or treat RFC 0095 as **current contract** (docs can assume Mark‑Sweep semantics even though code doesn’t implement it yet)?

    - **Resolution:** Describe Mark‑Sweep GC as **planned** (document today’s `locald registry clean` behavior only).
      - **Remediation priority:** Implementing RFC 0095-style TTL + periodic sweep + audit is an important near-term remediation step; docs should track it explicitly as “missing but planned” until it ships.

### Conflict Card C-010

- **Conflict ID:** C-010
- **Conflict:** User-facing docs teach both `locald run` and `locald exec` as the task-mode verb, but the project also has a strict single-canon docs policy.
- **Doc sources:**
  - locald-docs/src/content/docs/reference/cli.md (teaches `locald run`)
  - docs/manual/features/cli.md (teaches `locald run`)
  - locald-docs/src/content/docs/getting-started/index.mdx (uses `locald run ...`)
  - locald-docs/src/content/docs/guides/adhoc-tasks.md (uses `locald exec ...`)
  - docs/rfcs/0086-cli-surface-overhaul.md (specifies `locald exec` as renamed from `run`)
- **Implementation evidence:**
  - locald-cli/src/cli.rs defines the subcommand as `exec` with a clap alias `run` (`Exec { .. }` with `#[command(alias = "run")]`).
- **Candidate resolutions (do not pick yet):**
- **Candidate resolutions (considered):**
  - Canonical docs teach `locald exec` (treat `run` as a deprecated/hidden alias).
  - Canonical docs teach `locald run` (treat `exec` as reserved for a different future meaning).
- **Resolution:** Canonical docs teach **`locald run`** for **Spawn** (ephemeral tasks).
  - **Reservation:** **`locald exec` is reserved** for a future **Attach** operation (enter/attach to an already-running service/task) and should not appear in current user-facing docs.
  - **Remediation requirement:** Consolidate to one verb now: docs must use `run`; implementation should ultimately converge so `run` is the primary surface (with any temporary aliasing treated explicitly as migration, not as dual-canon).
  - **Follow-up RFC (planned):** Write a dedicated RFC defining Attach semantics, target identity, and dashboard visibility rules (Spawn shows as a task; Attach does not). This audit will only track the need; it will not create additional artifacts.

### Conflict Card C-011

- **Conflict ID:** C-011
- **Conflict:** The docs teach `locald try` as running commands in a “temporary, isolated environment” and show an image-like example (`python:3.9 ...`), but the implementation currently runs a local shell command (`sh -c ...`) with only environment injection (e.g. `PORT`) and an optional “save to locald.toml” prompt.
- **Doc sources:**
  - locald-docs/src/content/docs/reference/cli.md (describes “temporary, isolated environment”; example `locald try python:3.9 python my_script.py`)
  - docs/manual/features/cli.md (same `python:3.9` example)
- **Implementation evidence:**
  - locald-cli/src/handlers.rs runs `try_cmd::run_adhoc(command.join(" "))`
  - locald-cli/src/try_cmd.rs runs `sh -c <command>` and injects `PORT`, then appends history and optionally adds an exec service
- **Why it matters (which persona breaks, what failure occurs):**
  - App Builder: copy/paste from the CLI reference will fail immediately (“python:3.9: command not found”), undermining trust.
  - Power User: cannot reason about when to use `try` vs `container run` vs `run`.
- **Candidate resolutions (considered):**
  - Canonical contract: `locald try` is host-executed with env injection + save prompt; update docs/examples to match.
  - Canonical contract: `locald try` is isolated/image-based and should accept image-like invocations (e.g. `python:3.9 ...`).
- **Resolution:** `locald try` is canonically **host-executed**.
  - Docs must not imply isolation/images for `try`.
  - Image-based examples should be taught via `locald container run` (or a future explicit feature), not by overloading `try`.

### Conflict Card C-012

- **Conflict ID:** C-012
- **Conflict:** Managed Postgres persistence + reset semantics are inconsistent across docs and the implementation.
- **Doc sources:**
  - locald-docs/src/content/docs/guides/managed-services.md (claims persistence under `.locald/data/postgres-<name>` and shows a passworded `DATABASE_URL` example)
- **Implementation evidence:**
  - Postgres data directory is XDG-first (`ProjectDirs.data_dir()/postgres/<name>`) with `.locald/postgres/<name>` fallback (locald-server/src/service/postgres.rs)
  - `locald service reset` deletes `.locald/services/postgres/<short_name>` (locald-server/src/manager.rs)
- **Why it matters (which persona breaks, what failure occurs):**
  - App Builder: “reset” is expected to be a reliable DB wipe; if it deletes the wrong directory, users get surprising leftover data.
  - Power User/CI: automation around “reset between test runs” becomes flaky and hard to reason about.
- **Smallest question to user (one decision):**

  - What is the canonical persistence location for managed Postgres state: **workspace-local (`.locald/...`)** or **XDG data dir (`~/.local/share/...`)**?

- **Resolution:** Canonical persistence location is **XDG data dir**.
  - **Requirement:** Managed service state **must participate in the GC process**.
    - When GC runs (per C-009 resolution: Mark‑Sweep is planned), it must be able to remove managed Postgres state under XDG for projects/services that are not in the GC root set.
    - Until Mark‑Sweep GC exists, `locald service reset` is the user-facing “wipe this DB” operation and must delete the same XDG directory that Postgres is actually using.
  - **Doc remediation:** Update docs to stop claiming `.locald/data/postgres-<name>` and instead describe the XDG-first location (and whether `.locald/...` is used for anything other than config/service metadata).

### Conflict Card C-013

- **Conflict ID:** C-013
- **Conflict:** There is no single canonical connection-string surface for managed Postgres (and the password/auth story differs across surfaces).
- **Doc sources:**
  - locald-docs/src/content/docs/guides/managed-services.md (shows a passworded `DATABASE_URL=postgres://postgres:password@127.0.0.1:<port>/postgres`)
- **Implementation evidence:**
  - `${services.<name>.url}` resolves via manager field logic to `postgres://postgres:postgres@localhost:<port>/postgres` (hardcoded password) (locald-server/src/manager.rs: `get_service_field`)
  - Postgres controller metadata `url/connection_string` is `postgres://postgres@localhost:<port>/postgres` (no password) (locald-server/src/service/postgres.rs: `get_metadata`)
- **Why it matters (which persona breaks, what failure occurs):**
  - App Builder: expects the docs’ `DATABASE_URL` example to work reliably; inconsistent strings increase copy/paste failure and undermine trust.
  - Integrators: don’t know whether to depend on `${services.db.url}` or “service metadata url”; automation becomes brittle.
- **Smallest question to user (one decision):**
- **Smallest question to user (one decision):**
- What is the single canonical Postgres connection string surface: **`${services.<name>.url}`** or **service metadata (`url`/`connection_string`)**, and should it be **passworded or passwordless** as part of the stable contract?

- **Resolution:** Canonical connection string surface is **`${services.<name>.url}`**, and the stable contract is **passwordless by default**.
  - **Implications for docs:**
    - Docs should treat `${services.<name>.url}` as the one true source of the Postgres connection string.
    - Docs must not invent `:password` placeholders or suggest stable credentials unless the implementation explicitly commits to them.
  - **Implications for implementation (tracked as drift, not changed here):**
    - `${services.<name>.url}` must emit a passwordless URL (currently it hardcodes `postgres:postgres`).
    - Postgres metadata (`url`/`connection_string`) is either (a) diagnostic-only and not taught, or (b) must match `${services.<name>.url}` exactly; prefer (b) if we want one coherent story across surfaces.

## 11) Open Questions

- OQ-001: Should `locald config show --provenance` be upgraded from “global config debug dump” to a true provenance report (per RFC 0026), or should the docs/RFC expectations be revised?
- OQ-002: (Now Conflict Card C-003) What is the intended default domain behavior for a newly initialized project?
- OQ-003: Is the web dashboard URL canonically `http://locald.localhost` (as in docs/design/user-interaction-modes.md and RFC 0086), and does `locald dashboard` open that exact URL?

## 12) Appendix: Evidence Notes

### Vocabulary normalization punch list (strict single-canon)

Canonical spellings to teach and use everywhere:

- Replace `locald start` with `locald up`.
- Replace `locald ui` with `locald monitor` (TUI) or `locald dashboard` (web). Avoid using `ui` as a command name.
- Replace `locald prune` with `locald registry clean` (describe it as “prune missing projects”).
- Task-mode: teach **`locald run`** for spawning ephemeral tasks.
  - Reserve **`locald exec`** for a future Attach operation (do not teach `exec` in current user docs).
- Draft-mode: teach **`locald try`** as a host-executed scratchpad command runner that injects dev env (e.g. `$PORT`) and can optionally be promoted into `locald.toml`.
- Reserve **registry policy** terminology as `pin` + `disable` (“retain + enabled/disabled when the daemon starts”).
- Replace **dashboard UI** “pin” language (Deck/Stream focus) with **“monitor”** (C-008).
- Replace “Always Up”/`always_up` terminology with the approved **registry policy** language: `pin` (retain + enabled when the daemon starts) and `disable` (retain + do not autostart).

Doc-only / non-existent command spellings that must be removed from user-facing docs:

- Remove `locald down` until it is implemented.

User-facing docs/site content that still reference legacy spellings:

- docs/design/user-interaction-modes.md:20 (`locald start`)
- docs/design/user-interaction-modes.md:29 (`locald prune`)
- docs/design/user-interaction-modes.md:38 (`locald ui`)
- docs/design/axioms/experience/01-zero-friction-start.md:17 (`locald prune`)

- docs/manual/features/docker-integration.md:14 (`locald start`)
- docs/manual/features/constellations-and-config.md:34 (`locald start`)
- docs/manual/architecture/state-management.md:50 (`locald start`)

- docs/manual/features/cli.md:22 (`locald down`)

- locald-docs/src/content/docs/concepts/user-interaction-modes.md:22 (`locald start`)
- locald-docs/src/content/docs/concepts/user-interaction-modes.md:31 (`locald prune`)
- locald-docs/src/content/docs/concepts/user-interaction-modes.md:40 (`locald ui`)
- locald-docs/src/content/docs/internals/axioms/experience/01-zero-friction-start.md:19 (`locald prune`)
- locald-docs/src/content/docs/internals/rfcs/docker-integration.md:16 (`locald start`)
- locald-docs/src/content/docs/internals/rfcs/constellations-and-config.md:36 (`locald start`)

- locald-docs/src/content/docs/reference/cli.md:18 (`locald down`)

User-facing docs/site content that still use dashboard “pin” wording (should become “monitor”):

- docs/manual/features/dashboard-ui.md (Deck section: “Unified Pinning”, “pinned services”)
- locald-docs/src/content/docs/concepts/workspace.md (“pin one or more services”, “Unified pinning”)
- locald-docs/src/content/docs/getting-started/index.mdx (“Pin services into a focused, tiled layout”; “Pin locald itself…”)

Non-user-facing / historical references (optional cleanup for contributor clarity; not required for user docs correctness):

- docs/rfcs/0004-architecture-daemon-cli.md:28 (`locald start`)
- docs/archive/pre-rfc-transition/design/architecture/ssl.md:38 (`locald start`)
- docs/archive/pre-rfc-transition/design/epoch-3-hybrid/constellations-and-config.md:34 (`locald start`)
- docs/archive/pre-rfc-transition/design/epoch-3-hybrid/docker-integration.md:14 (`locald start`)
- docs/agent-context/archive/2025-11-30_12-51-49/implementation-plan.md:30 (`locald start`)
- docs/agent-context/archive/2025-11-30_12-51-49/implementation-plan.md:37 (`locald start`)
- docs/agent-context/archive/2025-11-30_12-51-49/walkthrough.md:22 (`locald start`)
- docs/agent-context/archive/2025-11-30_15-20-55/walkthrough.md:33 (`locald start`)
- docs/agent-context/archive/2025-12-01_00-00-49/implementation-plan.md:56 (`locald start`)
- docs/agent-context/archive/2025-12-02_09-34-53/implementation-plan.md:21 (`locald start`)
- docs/agent-context/archive/2025-12-02_09-34-53/implementation-plan.md:37 (`locald start`)
- docs/agent-context/archive/2025-12-02_09-34-53/implementation-plan.md:41 (`locald start`)
- docs/agent-context/archive/2025-12-03_08-00-14/implementation-plan.md:30 (`locald start`)

Commands run: none (read-only inspection only).

Files inspected (initial):

- README.md
- docs/design/vision.md
- docs/design/personas.md
- docs/design/axioms.md
- docs/design/user-interaction-modes.md
- locald-docs/src/content/docs/concepts/user-interaction-modes.md
- docs/manual/vision.md
- docs/rfcs/0014-documentation-personas.md
- docs/rfcs/0026-configuration-hierarchy.md
- docs/rfcs/0086-cli-surface-overhaul.md
- locald-cli/README.md
- locald-cli/src/cli.rs
- locald-cli/src/main.rs
- locald-cli/src/handlers.rs
- locald-cli/src/init.rs
- locald-cli/src/utils.rs
- locald-core/src/config/mod.rs
- locald-core/src/config/global.rs
- locald-core/src/registry.rs
- locald-utils/src/ipc.rs
