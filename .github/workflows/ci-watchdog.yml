name: CI Watchdog

on:
  schedule:
    # Hourly. Keeps a durable artifact (issue) when main is red.
    - cron: "17 * * * *"
  workflow_dispatch: {}

permissions:
  actions: read
  issues: write

jobs:
  watchdog:
    name: Main CI Red Watchdog
    runs-on: ubuntu-latest
    steps:
      - name: Determine latest CI status for main
        id: ci
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail

          url="https://api.github.com/repos/$REPO/actions/workflows/ci.yml/runs?branch=main&event=push&per_page=1"
          json=$(curl -fsSL -H "Authorization: Bearer $GH_TOKEN" -H "X-GitHub-Api-Version: 2022-11-28" "$url")

          conclusion=$(jq -r '.workflow_runs[0].conclusion // ""' <<<"$json")
          html_url=$(jq -r '.workflow_runs[0].html_url // ""' <<<"$json")
          head_sha=$(jq -r '.workflow_runs[0].head_sha // ""' <<<"$json")

          echo "conclusion=$conclusion" >> "$GITHUB_OUTPUT"
          echo "url=$html_url" >> "$GITHUB_OUTPUT"
          echo "sha=$head_sha" >> "$GITHUB_OUTPUT"

      - name: Open/update issue if main is red
        if: ${{ steps.ci.outputs.conclusion != 'success' && steps.ci.outputs.conclusion != '' }}
        uses: actions/github-script@v7
        env:
          CI_URL: ${{ steps.ci.outputs.url }}
          CI_SHA: ${{ steps.ci.outputs.sha }}
          CI_CONCLUSION: ${{ steps.ci.outputs.conclusion }}
        with:
          script: |
            const title = "CI is red on main";
            const body = [
              `Latest main CI conclusion: **${process.env.CI_CONCLUSION}**`,
              `Run: ${process.env.CI_URL}`,
              `SHA: ${process.env.CI_SHA}`,
              "",
              "This issue is maintained by CI Watchdog to provide a durable artifact when main is not green."
            ].join("\n");

            const { owner, repo } = context.repo;
            const issues = await github.rest.issues.listForRepo({ owner, repo, state: "open", per_page: 100 });
            const existing = issues.data.find(i => i.title === title);

            if (existing) {
              await github.rest.issues.update({ owner, repo, issue_number: existing.number, body });
            } else {
              await github.rest.issues.create({ owner, repo, title, body });
            }

      - name: Main is green
        if: ${{ steps.ci.outputs.conclusion == 'success' || steps.ci.outputs.conclusion == '' }}
        run: echo "Main CI is green (or no runs yet)."
